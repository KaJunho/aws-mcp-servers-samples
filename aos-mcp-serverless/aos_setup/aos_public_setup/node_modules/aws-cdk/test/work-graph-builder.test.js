"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const cxschema = require("@aws-cdk/cloud-assembly-schema");
const cx_api_1 = require("@aws-cdk/cx-api");
const work_graph_builder_1 = require("../lib/util/work-graph-builder");
let rootBuilder;
beforeEach(() => {
    rootBuilder = new cx_api_1.CloudAssemblyBuilder();
});
afterEach(() => {
    rootBuilder.delete();
});
describe('with some stacks and assets', () => {
    let assembly;
    beforeEach(() => {
        addSomeStacksAndAssets(rootBuilder);
        assembly = rootBuilder.buildAssembly();
    });
    test('stack depends on the asset publishing step', () => {
        const graph = new work_graph_builder_1.WorkGraphBuilder(true).build(assembly.artifacts);
        expect(assertableNode(graph.node('stack2'))).toEqual(expect.objectContaining({
            type: 'stack',
            dependencies: expect.arrayContaining(['F1:D1-publish']),
        }));
    });
    test('asset publishing step depends on asset building step', () => {
        const graph = new work_graph_builder_1.WorkGraphBuilder(true).build(assembly.artifacts);
        expect(graph.node('F1:D1-publish')).toEqual(expect.objectContaining({
            type: 'asset-publish',
            dependencies: new Set(['F1:D1-build']),
        }));
    });
    test('with prebuild off, asset building inherits dependencies from their parent stack', () => {
        const graph = new work_graph_builder_1.WorkGraphBuilder(false).build(assembly.artifacts);
        expect(graph.node('F1:D1-build')).toEqual(expect.objectContaining({
            type: 'asset-build',
            dependencies: new Set(['stack0', 'stack1']),
        }));
    });
    test('with prebuild on, assets only have their own dependencies', () => {
        const graph = new work_graph_builder_1.WorkGraphBuilder(true).build(assembly.artifacts);
        expect(graph.node('F1:D1-build')).toEqual(expect.objectContaining({
            type: 'asset-build',
            dependencies: new Set(['stack0']),
        }));
    });
});
test('tree metadata is ignored', async () => {
    rootBuilder.addArtifact('tree', {
        type: cxschema.ArtifactType.CDK_TREE,
        properties: {
            file: 'doesnotexist.json',
        },
    });
    const assembly = rootBuilder.buildAssembly();
    const graph = new work_graph_builder_1.WorkGraphBuilder(true).build(assembly.artifacts);
    expect(graph.ready().length).toEqual(0);
});
test('can handle nested assemblies', async () => {
    addSomeStacksAndAssets(rootBuilder);
    const nested = rootBuilder.createNestedAssembly('nested', 'Nested Assembly');
    addSomeStacksAndAssets(nested);
    nested.buildAssembly();
    const assembly = rootBuilder.buildAssembly();
    let workDone = 0;
    const graph = new work_graph_builder_1.WorkGraphBuilder(true).build(assembly.artifacts);
    await graph.doParallel(10, {
        deployStack: async () => { workDone += 1; },
        buildAsset: async () => { },
        publishAsset: async () => { workDone += 1; },
    });
    expect(workDone).toEqual(8);
});
test('dependencies on unselected artifacts are silently ignored', async () => {
    addStack(rootBuilder, 'stackA', {
        environment: 'aws://222222/us-east-1',
    });
    addStack(rootBuilder, 'stackB', {
        dependencies: ['stackA'],
        environment: 'aws://222222/us-east-1',
    });
    const asm = rootBuilder.buildAssembly();
    const graph = new work_graph_builder_1.WorkGraphBuilder(true).build([asm.getStackArtifact('stackB')]);
    expect(graph.ready()[0]).toEqual(expect.objectContaining({
        id: 'stackB',
        dependencies: new Set(),
    }));
});
/**
 * Write an asset manifest file and add it to the assembly builder
 */
function addAssets(builder, artifactId, options) {
    const manifestFile = `${artifactId}.json`;
    const outPath = path.join(builder.outdir, manifestFile);
    const manifest = {
        version: cxschema.Manifest.version(),
        files: options.files,
    };
    fs.writeFileSync(outPath, JSON.stringify(manifest, undefined, 2));
    builder.addArtifact(artifactId, {
        type: cxschema.ArtifactType.ASSET_MANIFEST,
        dependencies: options.dependencies,
        properties: {
            file: manifestFile,
        },
    });
}
/**
 * Add a stack to the cloud assembly
 */
function addStack(builder, stackId, options) {
    const templateFile = `${stackId}.template.json`;
    const outPath = path.join(builder.outdir, templateFile);
    fs.writeFileSync(outPath, JSON.stringify({}, undefined, 2));
    builder.addArtifact(stackId, {
        type: cxschema.ArtifactType.AWS_CLOUDFORMATION_STACK,
        dependencies: options.dependencies,
        environment: options.environment,
        properties: {
            templateFile,
        },
    });
}
function addSomeStacksAndAssets(builder) {
    addStack(builder, 'stack0', {
        environment: 'aws://11111/us-east-1',
    });
    addAssets(builder, 'stack2assets', {
        dependencies: ['stack0'],
        files: {
            F1: {
                source: { path: 'xyz' },
                destinations: {
                    D1: { bucketName: 'bucket', objectKey: 'key' },
                },
            },
        },
    });
    addStack(builder, 'stack1', {
        environment: 'aws://11111/us-east-1',
    });
    addStack(builder, 'stack2', {
        environment: 'aws://11111/us-east-1',
        dependencies: ['stack2assets', 'stack1'],
    });
}
/**
 * We can't do arrayContaining on the set that a Node has, so convert it to an array for asserting
 */
function assertableNode(x) {
    return {
        ...x,
        dependencies: Array.from(x.dependencies),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29yay1ncmFwaC1idWlsZGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3b3JrLWdyYXBoLWJ1aWxkZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsMkRBQTJEO0FBRTNELDRDQUF1RDtBQUN2RCx1RUFBa0U7QUFHbEUsSUFBSSxXQUFpQyxDQUFDO0FBQ3RDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxXQUFXLEdBQUcsSUFBSSw2QkFBb0IsRUFBRSxDQUFDO0FBQzNDLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLEVBQUU7SUFDM0MsSUFBSSxRQUE2QixDQUFDO0lBQ2xDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQUcsV0FBVyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDRDQUE0QyxFQUFFLEdBQUcsRUFBRTtRQUN0RCxNQUFNLEtBQUssR0FBRyxJQUFJLHFDQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbkUsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQzNFLElBQUksRUFBRSxPQUFPO1lBQ2IsWUFBWSxFQUFFLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUMzQyxDQUFDLENBQUMsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FB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QUFPLENBQUMsWUFBWTtRQUNsQyxXQUFXLEVBQUUsT0FBTyxDQUFDLFdBQVc7UUFDaEMsVUFBVSxFQUFFO1lBQ1YsWUFBWTtTQUNiO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUMsT0FBNkI7SUFDM0QsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUU7UUFDMUIsV0FBVyxFQUFFLHVCQUF1QjtLQUNyQyxDQUFDLENBQUM7SUFDSCxTQUFTLENBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRTtRQUNqQyxZQUFZLEVBQUUsQ0FBQyxRQUFRLENBQUM7UUFDeEIsS0FBSyxFQUFFO1lBQ0wsRUFBRSxFQUFFO2dCQUNGLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUU7Z0JBQ3ZCLFlBQVksRUFBRTtvQkFDWixFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUU7aUJBQy9DO2FBQ0Y7U0FDRjtLQUNGLENBQUMsQ0FBQztJQUNILFFBQVEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFO1FBQzFCLFdBQVcsRUFBRSx1QkFBdUI7S0FDckMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUU7UUFDMUIsV0FBVyxFQUFFLHVCQUF1QjtRQUNwQyxZQUFZLEVBQUUsQ0FBQyxjQUFjLEVBQUUsUUFBUSxDQUFDO0tBQ3pDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFxQixDQUFJO0lBQzlDLE9BQU87UUFDTCxHQUFHLENBQUM7UUFDSixZQUFZLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDO0tBQ3pDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGN4c2NoZW1hIGZyb20gJ0Bhd3MtY2RrL2Nsb3VkLWFzc2VtYmx5LXNjaGVtYSc7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgQ2xvdWRBc3NlbWJseUJ1aWxkZXIgfSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgV29ya0dyYXBoQnVpbGRlciB9IGZyb20gJy4uL2xpYi91dGlsL3dvcmstZ3JhcGgtYnVpbGRlcic7XG5pbXBvcnQgeyBBc3NldEJ1aWxkTm9kZSwgQXNzZXRQdWJsaXNoTm9kZSwgU3RhY2tOb2RlLCBXb3JrTm9kZSB9IGZyb20gJy4uL2xpYi91dGlsL3dvcmstZ3JhcGgtdHlwZXMnO1xuXG5sZXQgcm9vdEJ1aWxkZXI6IENsb3VkQXNzZW1ibHlCdWlsZGVyO1xuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHJvb3RCdWlsZGVyID0gbmV3IENsb3VkQXNzZW1ibHlCdWlsZGVyKCk7XG59KTtcblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgcm9vdEJ1aWxkZXIuZGVsZXRlKCk7XG59KTtcblxuZGVzY3JpYmUoJ3dpdGggc29tZSBzdGFja3MgYW5kIGFzc2V0cycsICgpID0+IHtcbiAgbGV0IGFzc2VtYmx5OiBjeGFwaS5DbG91ZEFzc2VtYmx5O1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhZGRTb21lU3RhY2tzQW5kQXNzZXRzKHJvb3RCdWlsZGVyKTtcbiAgICBhc3NlbWJseSA9IHJvb3RCdWlsZGVyLmJ1aWxkQXNzZW1ibHkoKTtcbiAgfSk7XG5cbiAgdGVzdCgnc3RhY2sgZGVwZW5kcyBvbiB0aGUgYXNzZXQgcHVibGlzaGluZyBzdGVwJywgKCkgPT4ge1xuICAgIGNvbnN0IGdyYXBoID0gbmV3IFdvcmtHcmFwaEJ1aWxkZXIodHJ1ZSkuYnVpbGQoYXNzZW1ibHkuYXJ0aWZhY3RzKTtcblxuICAgIGV4cGVjdChhc3NlcnRhYmxlTm9kZShncmFwaC5ub2RlKCdzdGFjazInKSkpLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgdHlwZTogJ3N0YWNrJyxcbiAgICAgIGRlcGVuZGVuY2llczogZXhwZWN0LmFycmF5Q29udGFpbmluZyhbJ0YxOkQxLXB1Ymxpc2gnXSksXG4gICAgfSBhcyBTdGFja05vZGUpKTtcbiAgfSk7XG5cbiAgdGVzdCgnYXNzZXQgcHVibGlzaGluZyBzdGVwIGRlcGVuZHMgb24gYXNzZXQgYnVpbGRpbmcgc3RlcCcsICgpID0+IHtcbiAgICBjb25zdCBncmFwaCA9IG5ldyBXb3JrR3JhcGhCdWlsZGVyKHRydWUpLmJ1aWxkKGFzc2VtYmx5LmFydGlmYWN0cyk7XG5cbiAgICBleHBlY3QoZ3JhcGgubm9kZSgnRjE6RDEtcHVibGlzaCcpKS50b0VxdWFsKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgIHR5cGU6ICdhc3NldC1wdWJsaXNoJyxcbiAgICAgIGRlcGVuZGVuY2llczogbmV3IFNldChbJ0YxOkQxLWJ1aWxkJ10pLFxuICAgIH0gYXMgUGFydGlhbDxBc3NldFB1Ymxpc2hOb2RlPikpO1xuICB9KTtcblxuICB0ZXN0KCd3aXRoIHByZWJ1aWxkIG9mZiwgYXNzZXQgYnVpbGRpbmcgaW5oZXJpdHMgZGVwZW5kZW5jaWVzIGZyb20gdGhlaXIgcGFyZW50IHN0YWNrJywgKCkgPT4ge1xuICAgIGNvbnN0IGdyYXBoID0gbmV3IFdvcmtHcmFwaEJ1aWxkZXIoZmFsc2UpLmJ1aWxkKGFzc2VtYmx5LmFydGlmYWN0cyk7XG5cbiAgICBleHBlY3QoZ3JhcGgubm9kZSgnRjE6RDEtYnVpbGQnKSkudG9FcXVhbChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICB0eXBlOiAnYXNzZXQtYnVpbGQnLFxuICAgICAgZGVwZW5kZW5jaWVzOiBuZXcgU2V0KFsnc3RhY2swJywgJ3N0YWNrMSddKSxcbiAgICB9IGFzIFBhcnRpYWw8QXNzZXRCdWlsZE5vZGU+KSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3dpdGggcHJlYnVpbGQgb24sIGFzc2V0cyBvbmx5IGhhdmUgdGhlaXIgb3duIGRlcGVuZGVuY2llcycsICgpID0+IHtcbiAgICBjb25zdCBncmFwaCA9IG5ldyBXb3JrR3JhcGhCdWlsZGVyKHRydWUpLmJ1aWxkKGFzc2VtYmx5LmFydGlmYWN0cyk7XG5cbiAgICBleHBlY3QoZ3JhcGgubm9kZSgnRjE6RDEtYnVpbGQnKSkudG9FcXVhbChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICB0eXBlOiAnYXNzZXQtYnVpbGQnLFxuICAgICAgZGVwZW5kZW5jaWVzOiBuZXcgU2V0KFsnc3RhY2swJ10pLFxuICAgIH0gYXMgUGFydGlhbDxBc3NldEJ1aWxkTm9kZT4pKTtcbiAgfSk7XG59KTtcblxudGVzdCgndHJlZSBtZXRhZGF0YSBpcyBpZ25vcmVkJywgYXN5bmMgKCkgPT4ge1xuICByb290QnVpbGRlci5hZGRBcnRpZmFjdCgndHJlZScsIHtcbiAgICB0eXBlOiBjeHNjaGVtYS5BcnRpZmFjdFR5cGUuQ0RLX1RSRUUsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgZmlsZTogJ2RvZXNub3RleGlzdC5qc29uJyxcbiAgICB9IGFzIGN4c2NoZW1hLlRyZWVBcnRpZmFjdFByb3BlcnRpZXMsXG4gIH0pO1xuXG4gIGNvbnN0IGFzc2VtYmx5ID0gcm9vdEJ1aWxkZXIuYnVpbGRBc3NlbWJseSgpO1xuXG4gIGNvbnN0IGdyYXBoID0gbmV3IFdvcmtHcmFwaEJ1aWxkZXIodHJ1ZSkuYnVpbGQoYXNzZW1ibHkuYXJ0aWZhY3RzKTtcbiAgZXhwZWN0KGdyYXBoLnJlYWR5KCkubGVuZ3RoKS50b0VxdWFsKDApO1xufSk7XG5cbnRlc3QoJ2NhbiBoYW5kbGUgbmVzdGVkIGFzc2VtYmxpZXMnLCBhc3luYyAoKSA9PiB7XG4gIGFkZFNvbWVTdGFja3NBbmRBc3NldHMocm9vdEJ1aWxkZXIpO1xuICBjb25zdCBuZXN0ZWQgPSByb290QnVpbGRlci5jcmVhdGVOZXN0ZWRBc3NlbWJseSgnbmVzdGVkJywgJ05lc3RlZCBBc3NlbWJseScpO1xuICBhZGRTb21lU3RhY2tzQW5kQXNzZXRzKG5lc3RlZCk7XG4gIG5lc3RlZC5idWlsZEFzc2VtYmx5KCk7XG5cbiAgY29uc3QgYXNzZW1ibHkgPSByb290QnVpbGRlci5idWlsZEFzc2VtYmx5KCk7XG5cbiAgbGV0IHdvcmtEb25lID0gMDtcbiAgY29uc3QgZ3JhcGggPSBuZXcgV29ya0dyYXBoQnVpbGRlcih0cnVlKS5idWlsZChhc3NlbWJseS5hcnRpZmFjdHMpO1xuICBhd2FpdCBncmFwaC5kb1BhcmFsbGVsKDEwLCB7XG4gICAgZGVwbG95U3RhY2s6IGFzeW5jICgpID0+IHsgd29ya0RvbmUgKz0gMTsgfSxcbiAgICBidWlsZEFzc2V0OiBhc3luYyAoKSA9PiB7IH0sXG4gICAgcHVibGlzaEFzc2V0OiBhc3luYyAoKSA9PiB7IHdvcmtEb25lICs9IDE7IH0sXG4gIH0pO1xuXG4gIGV4cGVjdCh3b3JrRG9uZSkudG9FcXVhbCg4KTtcbn0pO1xuXG50ZXN0KCdkZXBlbmRlbmNpZXMgb24gdW5zZWxlY3RlZCBhcnRpZmFjdHMgYXJlIHNpbGVudGx5IGlnbm9yZWQnLCBhc3luYyAoKSA9PiB7XG4gIGFkZFN0YWNrKHJvb3RCdWlsZGVyLCAnc3RhY2tBJywge1xuICAgIGVudmlyb25tZW50OiAnYXdzOi8vMjIyMjIyL3VzLWVhc3QtMScsXG4gIH0pO1xuICBhZGRTdGFjayhyb290QnVpbGRlciwgJ3N0YWNrQicsIHtcbiAgICBkZXBlbmRlbmNpZXM6IFsnc3RhY2tBJ10sXG4gICAgZW52aXJvbm1lbnQ6ICdhd3M6Ly8yMjIyMjIvdXMtZWFzdC0xJyxcbiAgfSk7XG5cbiAgY29uc3QgYXNtID0gcm9vdEJ1aWxkZXIuYnVpbGRBc3NlbWJseSgpO1xuICBjb25zdCBncmFwaCA9IG5ldyBXb3JrR3JhcGhCdWlsZGVyKHRydWUpLmJ1aWxkKFthc20uZ2V0U3RhY2tBcnRpZmFjdCgnc3RhY2tCJyldKTtcbiAgZXhwZWN0KGdyYXBoLnJlYWR5KClbMF0pLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgIGlkOiAnc3RhY2tCJyxcbiAgICBkZXBlbmRlbmNpZXM6IG5ldyBTZXQoKSxcbiAgfSkpO1xufSk7XG5cbi8qKlxuICogV3JpdGUgYW4gYXNzZXQgbWFuaWZlc3QgZmlsZSBhbmQgYWRkIGl0IHRvIHRoZSBhc3NlbWJseSBidWlsZGVyXG4gKi9cbmZ1bmN0aW9uIGFkZEFzc2V0cyhcbiAgYnVpbGRlcjogQ2xvdWRBc3NlbWJseUJ1aWxkZXIsXG4gIGFydGlmYWN0SWQ6IHN0cmluZyxcbiAgb3B0aW9uczogeyBmaWxlczogUmVjb3JkPHN0cmluZywgY3hzY2hlbWEuRmlsZUFzc2V0PiwgZGVwZW5kZW5jaWVzPzogc3RyaW5nW10gfSxcbikge1xuICBjb25zdCBtYW5pZmVzdEZpbGUgPSBgJHthcnRpZmFjdElkfS5qc29uYDtcbiAgY29uc3Qgb3V0UGF0aCA9IHBhdGguam9pbihidWlsZGVyLm91dGRpciwgbWFuaWZlc3RGaWxlKTtcblxuICBjb25zdCBtYW5pZmVzdDogY3hzY2hlbWEuQXNzZXRNYW5pZmVzdCA9IHtcbiAgICB2ZXJzaW9uOiBjeHNjaGVtYS5NYW5pZmVzdC52ZXJzaW9uKCksXG4gICAgZmlsZXM6IG9wdGlvbnMuZmlsZXMsXG4gIH07XG5cbiAgZnMud3JpdGVGaWxlU3luYyhvdXRQYXRoLCBKU09OLnN0cmluZ2lmeShtYW5pZmVzdCwgdW5kZWZpbmVkLCAyKSk7XG5cbiAgYnVpbGRlci5hZGRBcnRpZmFjdChhcnRpZmFjdElkLCB7XG4gICAgdHlwZTogY3hzY2hlbWEuQXJ0aWZhY3RUeXBlLkFTU0VUX01BTklGRVNULFxuICAgIGRlcGVuZGVuY2llczogb3B0aW9ucy5kZXBlbmRlbmNpZXMsXG4gICAgcHJvcGVydGllczoge1xuICAgICAgZmlsZTogbWFuaWZlc3RGaWxlLFxuICAgIH0gYXMgY3hzY2hlbWEuQXNzZXRNYW5pZmVzdFByb3BlcnRpZXMsXG4gIH0pO1xufVxuXG4vKipcbiAqIEFkZCBhIHN0YWNrIHRvIHRoZSBjbG91ZCBhc3NlbWJseVxuICovXG5mdW5jdGlvbiBhZGRTdGFjayhidWlsZGVyOiBDbG91ZEFzc2VtYmx5QnVpbGRlciwgc3RhY2tJZDogc3RyaW5nLCBvcHRpb25zOiB7IGVudmlyb25tZW50OiBzdHJpbmcsIGRlcGVuZGVuY2llcz86IHN0cmluZ1tdIH0pIHtcbiAgY29uc3QgdGVtcGxhdGVGaWxlID0gYCR7c3RhY2tJZH0udGVtcGxhdGUuanNvbmA7XG4gIGNvbnN0IG91dFBhdGggPSBwYXRoLmpvaW4oYnVpbGRlci5vdXRkaXIsIHRlbXBsYXRlRmlsZSk7XG4gIGZzLndyaXRlRmlsZVN5bmMob3V0UGF0aCwgSlNPTi5zdHJpbmdpZnkoe30sIHVuZGVmaW5lZCwgMikpO1xuXG4gIGJ1aWxkZXIuYWRkQXJ0aWZhY3Qoc3RhY2tJZCwge1xuICAgIHR5cGU6IGN4c2NoZW1hLkFydGlmYWN0VHlwZS5BV1NfQ0xPVURGT1JNQVRJT05fU1RBQ0ssXG4gICAgZGVwZW5kZW5jaWVzOiBvcHRpb25zLmRlcGVuZGVuY2llcyxcbiAgICBlbnZpcm9ubWVudDogb3B0aW9ucy5lbnZpcm9ubWVudCxcbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICB0ZW1wbGF0ZUZpbGUsXG4gICAgfSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGFkZFNvbWVTdGFja3NBbmRBc3NldHMoYnVpbGRlcjogQ2xvdWRBc3NlbWJseUJ1aWxkZXIpIHtcbiAgYWRkU3RhY2soYnVpbGRlciwgJ3N0YWNrMCcsIHtcbiAgICBlbnZpcm9ubWVudDogJ2F3czovLzExMTExL3VzLWVhc3QtMScsXG4gIH0pO1xuICBhZGRBc3NldHMoYnVpbGRlciwgJ3N0YWNrMmFzc2V0cycsIHtcbiAgICBkZXBlbmRlbmNpZXM6IFsnc3RhY2swJ10sXG4gICAgZmlsZXM6IHtcbiAgICAgIEYxOiB7XG4gICAgICAgIHNvdXJjZTogeyBwYXRoOiAneHl6JyB9LFxuICAgICAgICBkZXN0aW5hdGlvbnM6IHtcbiAgICAgICAgICBEMTogeyBidWNrZXROYW1lOiAnYnVja2V0Jywgb2JqZWN0S2V5OiAna2V5JyB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbiAgYWRkU3RhY2soYnVpbGRlciwgJ3N0YWNrMScsIHtcbiAgICBlbnZpcm9ubWVudDogJ2F3czovLzExMTExL3VzLWVhc3QtMScsXG4gIH0pO1xuICBhZGRTdGFjayhidWlsZGVyLCAnc3RhY2syJywge1xuICAgIGVudmlyb25tZW50OiAnYXdzOi8vMTExMTEvdXMtZWFzdC0xJyxcbiAgICBkZXBlbmRlbmNpZXM6IFsnc3RhY2syYXNzZXRzJywgJ3N0YWNrMSddLFxuICB9KTtcbn1cblxuLyoqXG4gKiBXZSBjYW4ndCBkbyBhcnJheUNvbnRhaW5pbmcgb24gdGhlIHNldCB0aGF0IGEgTm9kZSBoYXMsIHNvIGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgZm9yIGFzc2VydGluZ1xuICovXG5mdW5jdGlvbiBhc3NlcnRhYmxlTm9kZTxBIGV4dGVuZHMgV29ya05vZGU+KHg6IEEpIHtcbiAgcmV0dXJuIHtcbiAgICAuLi54LFxuICAgIGRlcGVuZGVuY2llczogQXJyYXkuZnJvbSh4LmRlcGVuZGVuY2llcyksXG4gIH07XG59Il19